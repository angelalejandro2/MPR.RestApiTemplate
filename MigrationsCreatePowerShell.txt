$timestamp = Get-Date -Format "yyyyMMddHHmmss"
$contextsPath = ".\Infrastructure\Context"
$startupProject = ".\MPR.RestApiTemplate.Api"
$project = ".\Infrastructure"

# Asegura que el CLI est√© disponible
if (-not (Get-Command "dotnet-ef" -ErrorAction SilentlyContinue)) {
    Write-Error "dotnet-ef is not installed. Run 'dotnet tool install --global dotnet-ef'"
    exit 1
}

Get-ChildItem -Path $contextsPath -Recurse -Filter *.cs | ForEach-Object {
    $fileContent = Get-Content $_.FullName -Raw
    $regex = '(?s)class\s+(\w+DbContext)\b.*?:\s*[\w<>,\s]*DbContext\b'
    if ($fileContent -match $regex) {
        $contextName = $matches[1]
        $contextShortName = $contextName -replace "DbContext$", ""
        $outputDir = "Migrations\$contextShortName"
        $migrationName = "AutoMigration_${contextName}_$timestamp"

        Write-Host "Generating migration for $contextName into $outputDir..."

        dotnet ef migrations add $migrationName `
            --project $project `
            --startup-project $startupProject `
            --context $contextName `
            --output-dir $outputDir
    }
}